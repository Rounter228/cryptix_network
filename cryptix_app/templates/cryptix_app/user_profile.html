{% extends 'cryptix_app/base.html' %}

{% block title %}{{ profile_user.username }}{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start;">
        <div style="flex: 1;">
            {% if profile.avatar %}
            <img src="{{ profile.avatar.url }}" alt="{{ profile_user.username }}" style="width: 120px; height: 120px; border-radius: 50%; margin-right: 20px; float: left;">
            {% else %}
            <div style="width: 120px; height: 120px; border-radius: 50%; background: #1877f2; color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; margin-right: 20px; float: left;">
                {{ profile_user.username|first|upper }}
            </div>
            {% endif %}
            
            <h2>{{ profile_user.first_name }} {{ profile_user.last_name }}</h2>
            <p style="color: #666;">@{{ profile_user.username }}</p>
            
            {% if profile.bio %}
            <p style="margin-top: 10px;">{{ profile.bio }}</p>
            {% endif %}
            
            <div style="margin-top: 15px; color: #666;">
                {% if profile.location %}
                <p>üìç {{ profile.location }}</p>
                {% endif %}
                {% if profile.website %}
                <p>üåê <a href="{{ profile.website }}" target="_blank">{{ profile.website }}</a></p>
                {% endif %}
                {% if profile.birth_date %}
                <p>üéÇ {{ profile.birth_date|date:"d.m.Y" }}</p>
                {% endif %}
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 20px;">
                <div><strong>{{ friends_count }}</strong> –¥—Ä—É–∑—ñ–≤</div>
                <div><strong>{{ followers_count }}</strong> –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</div>
                <div><strong>{{ following_count }}</strong> –ø—ñ–¥–ø–∏—Å–æ–∫</div>
                <div><strong>{{ groups_count }}</strong> –≥—Ä—É–ø</div>
            </div>
        </div>
        
        {% if profile_user != user %}
        <div style="display: flex; flex-direction: column; gap: 10px;">
            {% if is_friend %}
                <span style="color: #42b72a; padding: 10px;">‚úì –í–∏ –¥—Ä—É–∑—ñ</span>
                <a href="{% url 'start_conversation' profile_user.id %}">
                    <button>–ù–∞–ø–∏—Å–∞—Ç–∏</button>
                </a>
                <form method="post" action="{% url 'remove_friend' profile_user.id %}">
                    {% csrf_token %}
                    <button type="submit" style="background: #f44336;">–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –¥—Ä—É–∑—ñ–≤</button>
                </form>
            {% elif friendship_status == 'pending' %}
                <span style="color: #999;">–ó–∞–ø–∏—Ç –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ</span>
            {% else %}
                <form method="post" action="{% url 'send_friend_request' profile_user.id %}">
                    {% csrf_token %}
                    <button type="submit">–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ</button>
                </form>
            {% endif %}
            
            {% if is_following %}
                <form method="post" action="{% url 'unfollow_user' profile_user.id %}">
                    {% csrf_token %}
                    <button type="submit" style="background: #999;">–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è</button>
                </form>
            {% else %}
                <form method="post" action="{% url 'follow_user' profile_user.id %}">
                    {% csrf_token %}
                    <button type="submit">–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è</button>
                </form>
            {% endif %}
        </div>
        {% else %}
        <a href="{% url 'profile' %}">
            <button>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
        </a>
        {% endif %}
    </div>
</div>

<div class="card">
    <h3>–†–µ–π—Ç–∏–Ω–≥ —Ç–∞ –≤—ñ–¥–≥—É–∫–∏</h3>
    
    {% with reviews=profile_user.reviews_received.all %}
    {% if reviews %}
        {% with total=reviews.count sum=0 %}
            {% for review in reviews %}
                {% with sum=sum|add:review.rating %}{% endwith %}
            {% endfor %}
            {% with avg_rating=sum|divisibleby:total %}
            <div style="margin-bottom: 20px;">
                <div class="star-rating">
                    {% for i in "12345" %}
                    <span class="star filled">‚òÖ</span>
                    {% endfor %}
                </div>
                <p>–í—Å—å–æ–≥–æ –≤—ñ–¥–≥—É–∫—ñ–≤: <strong>{{ reviews.count }}</strong></p>
            </div>
            {% endwith %}
        {% endwith %}
    {% else %}
        <p style="margin-bottom: 20px;">–©–µ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤</p>
    {% endif %}
    
    {% if profile_user != user and is_friend %}
    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4>–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h4>
        <form method="post" action="{% url 'leave_review' profile_user.username %}">
            {% csrf_token %}
            <div style="margin: 10px 0;">
                <label>–†–µ–π—Ç–∏–Ω–≥:</label>
                <select name="rating" required style="width: auto;">
                    <option value="">–û–±–µ—Ä—ñ—Ç—å</option>
                    <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
                    <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4)</option>
                    <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (3)</option>
                    <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (2)</option>
                    <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (1)</option>
                </select>
            </div>
            <textarea name="comment" placeholder="–í–∞—à –≤—ñ–¥–≥—É–∫..." rows="3" required></textarea>
            <button type="submit">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </form>
    </div>
    {% endif %}
    
    {% for review in reviews %}
    <div style="border-bottom: 1px solid #ddd; padding: 15px 0;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
                <strong><a href="{% url 'user_profile_view' review.reviewer.username %}">{{ review.reviewer.username }}</a></strong>
                <div class="star-rating" style="font-size: 16px; margin: 5px 0;">
                    {% for i in "12345" %}
                    <span class="star {% if forloop.counter <= review.rating %}filled{% endif %}">‚òÖ</span>
                    {% endfor %}
                </div>
                <p>{{ review.comment }}</p>
                <small style="color: #999;">{{ review.created_at|date:"d.m.Y H:i" }}</small>
            </div>
            {% if review.reviewer == user %}
            <form method="post" action="{% url 'delete_review' review.id %}">
                {% csrf_token %}
                <button type="submit" style="background: #f44336;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    {% endwith %}
</div>
{% endblock %}